<!DOCTYPE html>
<html>
<head>
  <title>Seki – Editor Demo</title>
  <meta charset="utf-8">
  <meta name="author" content="Adam Reis">
  <link rel="stylesheet" type="text/css" media="screen" href="css/seki.css">
  <link rel="stylesheet" type="text/css" media="screen" href="css/demo.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png">
</head>
<body lang="en">
<div class="background"></div>
<div class="main" id="app">
  <div class="center">
    <div class="wrapper">
      <div id="player">
        <div id="board"></div>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="panel">
      <div class="block players">
        <div class="player black">
          <div class="identity">
            <div class="color black"></div>
            <div class="nameAndRank">
              <span class="name" id="playerBlackName">Black</span>
              <span class="rank" id="playerBlackRank"></span>
            </div>
          </div>
          <div class="score">
            <div id="blackCaptures">0 captures</div>
          </div>
        </div>
        <div class="player white">
          <div class="identity">
            <div class="color white"></div>
            <div class="nameAndRank">
              <span class="name" id="playerWhiteName">White</span>
              <span class="rank" id="playerWhiteRank"></span>
            </div>
          </div>
          <div class="score">
            <div id="whiteCaptures">0 captures</div>
            <div id="komi"></div>
          </div>
        </div>
      </div>

      <div class="block times hidden">
        <div class="time">
          <div class="timeLabel">time</div>
          <div id="blackTimeLeft">&nbsp;</div>
        </div>
        <div class="time">
          <div class="timeLabel">time</div>
          <div id="whiteTimeLeft">&nbsp;</div>
        </div>
      </div>

      <div class="block utility">
        <div class="buttons">
          <button class="btnCommand" cmd="reset" title="New file [shift-N]">
            <span class="icon material-symbols-outlined">note</span>
          </button>
          <button class="btnCommand" cmd="openFile" title="Load file from computer [shift-O]">
            <span class="icon material-symbols-outlined">upload_file</span>
          </button>
          <button class="btnCommand" cmd="loadFileFromUrl" title="Load file from OGS URL [shift-U]">
            <span class="icon material-symbols-outlined">cloud_upload</span>
          </button>
          <button class="btnCommand" cmd="downloadFile" title="Download file to computer [shift-D]">
            <span class="icon material-symbols-outlined">download_for_offline</span>
          </button>
          <!-- <button id="saveInCollection" title="Save file to your collection">
            <span class="icon material-symbols-outlined">cloud_download</span>
          </button> -->
          <button id="showInfo" title="View game information">
            <span class="icon material-symbols-outlined">info</span>
          </button>
          <button id="showSettings" title="Settings">
            <span class="icon material-symbols-outlined">tune</span>
          </button>
        </div>
      </div>

      <div class="block editing" id="tools">
        <div class="buttons">
          <button id="playMoves" class="btnSwitchMode active" mode="replay" title="Play moves [M]">
            <span class="material-symbols-outlined">fiber_smart_record</span>
          </button>

          <button class="btnTool" tool="stone" title="Place stone [S]">
            <span class="material-symbols-outlined">fiber_manual_record</span>
          </button>
          <button class="btnTool" tool="triangle" title="Triangle [1]">
            <span class="material-symbols-outlined">change_history</span>
          </button>
          <button class="btnTool" tool="square" title="Square [2]">
            <span class="material-symbols-outlined">square</span>
          </button>
          <button class="btnTool" tool="circle" title="Circle [3]">
            <span class="material-symbols-outlined">circle</span>
          </button>
          <!-- <button class="btnTool" tool="diamond" title="Diamond [4]">
            <span class="material-symbols-outlined">diamond</span>
          </button> -->
          <button class="btnTool" tool="letter" title="Letter [4]">
            <span class="material-symbols-outlined">abc</span>
          </button>
          <button class="btnTool" tool="number" title="Number [5]">
            <span class="material-symbols-outlined">123</span>
          </button>
          <button class="btnTool" tool="happy" title="Happy [6]">
            <span class="material-symbols-outlined">sentiment_satisfied</span>
          </button>
          <button class="btnTool" tool="sad" title="Sad [7]">
            <span class="material-symbols-outlined">sentiment_dissatisfied</span>
          </button>
          <button class="btnTool" tool="mark" title="Mark [8]">
            <span class="material-symbols-outlined">close</span>
          </button>
          <button class="btnTool" tool="draw" title="Free draw [9]">
            <span class="material-symbols-outlined">stylus_note</span>
          </button>

          <button class="btnTool" tool="clear" title="Remove markup or stones [X]">
            <span class="material-symbols-outlined">ink_eraser</span>
          </button>
          <button id="removeAllMarkup" title="Remove all markup [SHIFT-X]">
            <span class="material-symbols-outlined">delete_sweep</span>
          </button>
        </div>
      </div>

      <div class="block hidden" id="settings">
        <div class="settings">
          <label class="toggleConfig" config="showCoordinates">
            <input type="checkbox"> Show coordinates
          </label>
          <label class="toggleConfig" config="showLastMove">
            <input type="checkbox"> Show last move
          </label>
          <label class="toggleConfig" config="showNextMove">
            <input type="checkbox"> Show next move
          </label>
          <label class="toggleConfig" config="showAdvancedNavigation">
            <input type="checkbox"> Show advanced navigation
          </label>
          <label class="toggleConfig" config="showAllMoveNumbers">
            <input type="checkbox"> Show all move numbers
          </label>
          <label class="toggleConfig" config="showVariationMoveNumbers">
            <input type="checkbox"> Show variation move numbers
          </label>
          <label class="toggleConfig" config="showVariations">
            <input type="checkbox"> Show variations
          </label>
          <label class="toggleConfig" config="rememberVariationPath">
            <input type="checkbox"> Remember path taken
          </label>
          <label class="toggleConfig" config="swapColors">
            <input type="checkbox"> Swap colors
          </label>
        </div>
      </div>

      <div class="block hidden" id="gameInfo">
        <div class="gameInfo">
          <div class="row">
            <div class="label">Name</div>
            <div class="value" id="name"></div>
          </div>
          <div class="row">
            <div class="label">Date</div>
            <div class="value" id="date"></div>
          </div>
          <div class="row">
            <div class="label">Event</div>
            <div class="value" id="event"></div>
          </div>
          <div class="row">
            <div class="label">Rules</div>
            <div class="value" id="ruleSet"></div>
          </div>
          <div class="row">
            <div class="label">Time</div>
            <div class="value" id="time"></div>
          </div>
          <div class="row">
            <div class="label">Result</div>
            <div class="value" id="result"></div>
          </div>
        </div>
      </div>

      <div class="block navigation">
        <div class="buttons">
          <button class="btnCommand" cmd="goToFirstPosition" title="Go to first position [cmd ←]">
            <span class="material-symbols-outlined">first_page</span>
          </button>
          <button class="btnCommand" cmd="goBackNumPositions" title="Go back 10 positions [shift ←]">
            <span class="material-symbols-outlined">replay_10</span>
          </button>
          <button class="btnCommand" cmd="goToPreviousPosition" title="Go back [←]">
            <span class="material-symbols-outlined">navigate_before</span>
          </button>

          <button id="startAutoPlay" title="Start auto play [space]">
            <span class="material-symbols-outlined">play_arrow</span>
          </button>
          <button id="stopAutoPlay" class="active" title="Stop auto play [space]">
            <span class="material-symbols-outlined">stop</span>
          </button>

          <button class="btnCommand" cmd="goToNextPosition" title="Go forward [→]">
            <span class="material-symbols-outlined">navigate_next</span>
          </button>
          <button class="btnCommand" cmd="goForwardNumPositions" title="Go forward 10 positions [shift →]">
            <span class="material-symbols-outlined">forward_10</span>
          </button>
          <button class="btnCommand" cmd="goToLastPosition" title="Go to last position [cmd →]">
            <span class="material-symbols-outlined">last_page</span>
          </button>

          <button class="btnCommand advancedNav" cmd="goToPreviousFork" title="Go to previous fork [alt ←]">
            <span class="material-symbols-outlined">fork_left</span>
          </button>
          <button class="btnCommand advancedNav" cmd="goToNextFork" title="Go to next fork [alt →]">
            <span class="material-symbols-outlined">fork_right</span>
          </button>
          <button class="btnCommand advancedNav" cmd="goToPreviousComment" title="Go to previous comment">
            <span class="material-symbols-outlined">comment</span>
          </button>
          <button class="btnCommand advancedNav" cmd="goToNextComment" title="Go to next comment">
            <span class="material-symbols-outlined">chat</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="module">
import {
  Board,
  Player,
  constants,
  helpers
} from '../../src/index.js'
import {
  onClick,
  findByQuery,
  toggleHidden,
  toggleActive,
  isActive,
  setText,
  parseTime,
  parseOverTime
} from './js/demo.js'

//Audio
import audioMove from './audio/move.wav'
import audioCapture from './audio/capture.wav'

//Get constants
const {
  playerModes,
  playerActions,
  editTools
} = constants.player
const {
  stoneColors
} = constants.stone

//Set debug mode
helpers.util.setDebug(true)

//Find player element and instantiate player
const playerElement = document.getElementById('player')
const player = new Player({
  audio: {
    move: audioMove,
    capture: audioCapture,
  }
})

//Load config
const config = helpers.storage.get('config')
if (config) {
  player.loadConfig(config)
}

//Bootstrap player
player.bootstrap(playerElement)

//Settings
onClick('#showSettings', btn => {
  const active = isActive(btn)
  toggleActive('#showSettings', !active)
  toggleHidden('#settings', active)
  toggleActive('#showInfo', false)
  toggleHidden('#gameInfo', true)
  toggleHidden('#tools', !active)
})

//Game info
onClick('#showInfo', btn => {
  const active = isActive(btn)
  toggleActive('#showSettings', false)
  toggleHidden('#settings', true)
  toggleActive('#showInfo', !active)
  toggleHidden('#gameInfo', active)
  toggleHidden('#tools', !active)
})

//Mode switching
onClick('.btnSwitchMode', btn => {
  const mode = btn.getAttribute('mode')
  player.setMode(mode)
})

//Commands
onClick('.btnCommand', btn => {
  const cmd = btn.getAttribute('cmd')
  player[cmd]()
})

//Edit tool selection
onClick('.btnTool', btn => {
  const tool = btn.getAttribute('tool')
  player.setMode(playerModes.EDIT)
  player.setEditTool(tool)
})

//Config toggles
onClick('.toggleConfig', lbl => {
  const key = lbl.getAttribute('config')
  const input = lbl.querySelector('input')
  player.toggleConfig(key, input.checked)
})

//Auto play
onClick('#startAutoPlay', () => {
  player.processAction(playerActions.START_AUTO_PLAY)
})
onClick('#stopAutoPlay', () => {
  player.processAction(playerActions.STOP_AUTO_PLAY)
})

//Remove all markup
onClick('#removeAllMarkup', () => {
  player.processAction(playerActions.REMOVE_ALL_MARKUP)
})

//Set checkboxes to initial toggle value
findByQuery('.toggleConfig')
  .forEach(lbl => {
    const key = lbl.getAttribute('config')
    const input = lbl.querySelector('input')
    input.checked = player.getConfig(key)
  })

//Event handlers
player.on('pathChange', () => {
  const {game} = player
  const {black, white} = game.getCaptureCount()
  const node = game.getCurrentNode()

  //Set captures
  const bs = black === 1 ? '' : 's'
  const ws = white === 1 ? '' : 's'
  setText('#blackCaptures', `${black} capture${bs}`)
  setText('#whiteCaptures', `${white} capture${ws}`)

  //Set time left
  const blackTimeLeft = game.getTimeLeft(stoneColors.BLACK)
  const whiteTimeLeft = game.getTimeLeft(stoneColors.WHITE)
  const blackPeriodsLeft = game.getPeriodsLeft(stoneColors.BLACK)
  const whitePeriodsLeft = game.getPeriodsLeft(stoneColors.WHITE)
  if (blackTimeLeft) {
    toggleHidden('.times', false)
    if (blackPeriodsLeft) {
      setText('#blackTimeLeft', `${blackPeriodsLeft} x ${blackTimeLeft}s`)
    }
    else {
      setText('#blackTimeLeft', parseTime(blackTimeLeft))
    }
  }
  if (whiteTimeLeft) {
    toggleHidden('.times', false)
    if (whitePeriodsLeft) {
      setText('#whiteTimeLeft', `${whitePeriodsLeft} x ${whiteTimeLeft}s`)
    }
    else {
      setText('#whiteTimeLeft', parseTime(whiteTimeLeft))
    }
  }
})
player.on('modeChange', () => {
  toggleActive('#playMoves', player.isModeActive(playerModes.REPLAY))
})
player.on('editToolChange', (event) => {
  const {tool} = event.detail

  //Toggle tool buttons
  findByQuery('.btnTool')
    .forEach(btn => {
      toggleActive(btn, btn.getAttribute('tool') === tool)
    })
})
player.on('config', event => {
  const {key, value} = event.detail
  if (key === 'showAdvancedNavigation') {
    toggleHidden('.advancedNav', !value)
  }
  const config = player.getConfigCopy()
  helpers.storage.set('config', config)
})
player.on('gameLoad', () => {
  player.setMode(playerModes.REPLAY)
  const {game} = player
  const black = game.getBlackPlayer()
  const white = game.getWhitePlayer()
  const komi = game.getKomi()
  const result = game.getInfo('game.result')
  const name = game.getInfo('game.name')
  const dates = game.getInfo('game.dates')
  const rules = game.getInfo('rules')
  const event = game.getInfo('event')
  const source = game.getInfo('source')
  setText('#playerBlackName', black.name || 'Black')
  setText('#playerWhiteName', white.name || 'White')
  setText('#playerBlackRank', black.rank || '')
  setText('#playerWhiteRank', white.rank || '')
  setText('#komi', komi ? `+${komi}` : '')
  setText('#result', result || '?')
  setText('#name', name || '–')
  setText('#date', (dates && dates.length > 0) ? dates[0] : '')
  setText('#ruleSet', rules.ruleSet || '?')
  setText('#time', '')
  if (rules.mainTime) {
    const mt = parseTime(rules.mainTime)
    const ot = parseOverTime(rules.overTime)
    setText('#time', `${mt}${ot ? ` + ${ot}` : ''}`)
    toggleHidden('.times', false)
    setText('#blackTimeLeft', parseTime(rules.mainTime))
    setText('#whiteTimeLeft', parseTime(rules.mainTime))
  }
  setText('#event', '')
  if (event) {
    const parts = [
      event.name,
      event.location,
      event.round
    ].filter(p => !!p)
    if (parts.length > 0) {
      setText('#event', parts.join(', '))
    }
  }
})
player.on('autoPlayToggle', event => {
  const {isAutoPlaying} = event.detail
  toggleHidden('#startAutoPlay', isAutoPlaying)
  toggleHidden('#stopAutoPlay', !isAutoPlaying)
})

//Init
toggleHidden('#stopAutoPlay', true)
toggleHidden('.advancedNav', !player.getConfig('showAdvancedNavigation'))
</script>
</body>
</html>
